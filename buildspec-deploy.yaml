version: 0.2

phases:
  install:
    commands:
      - echo "‚öôÔ∏è Setting up kubectl..."
      - aws eks update-kubeconfig --region $AWS_REGION --name java-cluster
      # ensure AWS CLI has access to role creds
      - export KUBECONFIG=/root/.kube/config
      - export AWS_DEFAULT_REGION=$AWS_REGION
      - export AWS_REGION=$AWS_REGION
  build:
    commands:
      - IMAGE_URI=$(cat imageTag.txt)
      - echo "üöÄ Deploying $IMAGE_URI to $ENV namespace..."
      - sed -i "s|<IMAGE_PLACEHOLDER>|$IMAGE_URI|g" k8s/$ENV/deployment.yaml
      # üîç Debugging starts here
      - echo "Checking IAM identity..."
      - aws sts get-caller-identity
      - echo "Testing token fetch..."
      - aws eks get-token --region $AWS_REGION --cluster-name java-cluster
      - echo "===== kubeconfig ====="
      - cat /root/.kube/config
      - kubectl get ns
      # üîç Debugging ends here
      - kubectl apply -f k8s/$ENV/

